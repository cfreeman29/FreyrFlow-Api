<!DOCTYPE html>
<html>
<head>
  <title>Users</title>
  <link rel="stylesheet" type="text/css" href="/styles.css">
  <style>
    /* Existing styles */
  </style>
</head>
<body>
  <%- include('navbar') %>
  <div class="container">
    <h1>Users</h1>
    <table>
      <thead>
        <tr>
          <th>Username</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <% users.forEach((user) => { %>
          <tr>
            <td><%= user.username %></td>
            <td>
              <button class="delete-btn" data-user-id="<%= user._id %>">Delete</button>
            </td>
          </tr>
        <% }); %>
      </tbody>
    </table>
    <button id="createUserBtn" class="btn">Create User</button>
  </div>

  <div id="createUserModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Create User</h2>
        <span class="close">&times;</span>
      </div>
      <form id="createUserForm" action="/create-user" method="post">
        <div class="form-group">
          <label for="username">Username:</label>
          <input type="text" id="username" name="username" required>
        </div>
        <div class="form-group">
          <label for="password">Password:</label>
          <input type="password" id="password" name="password" required>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn-create">Create</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var modal = document.getElementById("createUserModal");
      var btn = document.getElementById("createUserBtn");
      var span = document.getElementsByClassName("close")[0];

      btn.onclick = function() {
        modal.style.display = "block";
      }

      span.onclick = function() {
        modal.style.display = "none";
      }

      window.onclick = function(event) {
        if (event.target == modal) {
          modal.style.display = "none";
        }
      }

      var createUserForm = document.getElementById('createUserForm');
      createUserForm.addEventListener('submit', function(event) {
        event.preventDefault();

        var formData = new FormData(createUserForm);
        var data = Object.fromEntries(formData.entries());

        fetch('/create-user', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            modal.style.display = "none";
            location.reload(); // Refresh the user list
          } else {
            alert(result.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while creating the user.');
        });
      });

      var deleteButtons = document.getElementsByClassName('delete-btn');
      Array.from(deleteButtons).forEach(function(button) {
        button.addEventListener('click', function() {
          var userId = this.getAttribute('data-user-id');
          var confirmDelete = confirm('Are you sure you want to delete this user?');

          if (confirmDelete) {
            fetch('/delete-user', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ userId: userId })
            })
            .then(response => response.json())
            .then(result => {
              if (result.success) {
                location.reload(); // Refresh the user list
              } else {
                alert('Failed to delete user');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('An error occurred while deleting the user');
            });
          }
        });
      });
    });
  </script>
</body>
</html>